{% comment %}
  Sticky Anchor Nav (Dawn) â€” v3 hybrid
  - Uses position: sticky when possible
  - Falls back to position: fixed with a placeholder to avoid layout jump
{% endcomment %}

{%- style -%}
  #shopify-section-{{ section.id }} { overflow: visible; position: relative; z-index: 2; } /* prevent clipping */
  .sticky-anchor-nav__wrap--{{ section.id }}{
    position: -webkit-sticky;
    position: sticky;
    top: {{ section.settings.sticky_top | default: 0 }}px;
    z-index: 40;
  }
  .sn-fixed-placeholder--{{ section.id }}{ height: 0; }

  .sticky-anchor-nav--{{ section.id }}.has-shadow { box-shadow: 0 2px 12px rgba(0,0,0,.06); }

  .sticky-anchor-nav--{{ section.id }} .rich-text__blocks{
    display:flex; gap:10px; align-items:center; white-space:nowrap;
    overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
  }
  .sticky-anchor-nav--{{ section.id }} .rich-text__blocks::-webkit-scrollbar{display:none;}
  .sticky-anchor-nav--{{ section.id }} .rich-text__buttons{display:inline-flex;}
  .sticky-anchor-nav--{{ section.id }} a.button.is-active{ outline:2px solid currentColor; outline-offset:1px; }
  .sticky-anchor-nav--{{ section.id }} .rich-text__wrapper{ padding: 3rem 0; }
  html:focus-within{ scroll-behavior:smooth; }
{%- endstyle -%}

<div class="isolate{% unless section.settings.full_width %} page-width{% endunless %}">
  <!-- placeholder to preserve height when we switch to fixed -->
  <div class="sn-fixed-placeholder--{{ section.id }}" aria-hidden="true"></div>

  <!-- sticky wrapper (works if ancestors allow it) -->
  <div class="sticky-anchor-nav__wrap--{{ section.id }}" data-sticky-wrap>
    <nav
      id="sticky-anchor-nav-{{ section.id }}"
      class="rich-text content-container color-{{ section.settings.color_scheme }} gradient{% if section.settings.full_width %} rich-text--full-width content-container--full-width{% endif %} sticky-anchor-nav--{{ section.id }}{% if section.settings.add_shadow %} has-shadow{% endif %}"
      data-scroll-offset="{{ section.settings.scroll_offset | default: section.settings.sticky_top | default: 80 }}"
      aria-label="Section navigation"
    >
      <div class="rich-text__wrapper rich-text__wrapper--{{ section.settings.desktop_content_position }}{% if section.settings.full_width %} page-width{% endif %}">
        <div class="rich-text__blocks {{ section.settings.content_alignment }}">
          {%- assign order = 0 -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'anchor_button' -%}
              {%- assign order = order | plus: 1 -%}
              <div class="rich-text__buttons{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
                   {{ block.shopify_attributes }}
                   {% if settings.animations_reveal_on_scroll %} data-cascade style="--animation-order: {{ order }};"{% endif %}>
                {%- assign label = block.settings.button_label | strip -%}
                {%- assign target = block.settings.anchor_id | handleize -%}
                {%- if label != blank -%}
                  <a
                    {% if target == blank %}role="link" aria-disabled="true"{% else %}href="#{{ target }}"{% endif %}
                    class="button{% if block.settings.button_style_secondary %} button--secondary{% else %} button--primary{% endif %}{% if forloop.first %} is-active{% endif %}"
                    data-anchor="{{ target }}"
                    {% if forloop.first %}aria-current="true"{% endif %}
                  >{{- label | escape -}}</a>
                {%- endif -%}
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </nav>
  </div>
</div>

<script>
(() => {
  const nav = document.getElementById('sticky-anchor-nav-{{ section.id }}');
  if (!nav) return;

  const offset = parseFloat(nav.dataset.scrollOffset || '{{ section.settings.sticky_top | default: 80 }}') || 80;

  // Collect links and normalize anchors from href="#id"
  const links = Array.from(nav.querySelectorAll('a.button'));
  links.forEach(a => {
    const href = (a.getAttribute('href') || '').trim();
    const id = href.startsWith('#') ? href.slice(1) : (a.dataset.anchor || '').trim();
    if (id) a.dataset.anchor = id;
  });

  const getTarget = (a) => a.dataset.anchor ? document.getElementById(a.dataset.anchor) : null;
  let targets = links.map(getTarget).filter(Boolean);

  const setActive = (id) => {
    links.forEach(a => {
      const on = a.dataset.anchor === id;
      a.classList.toggle('is-active', on);
      if (on) a.setAttribute('aria-current', 'true'); else a.removeAttribute('aria-current');
    });
  };

  // Immediate visual feedback on click
  links.forEach(a => {
    a.addEventListener('click', (e) => {
      const id = a.dataset.anchor;
      const el = id && document.getElementById(id);
      if (!el) return;
      // smooth scroll with offset
      e.preventDefault();
      const top = el.getBoundingClientRect().top + window.pageYOffset - offset;
      window.scrollTo({ top, behavior: 'smooth' });
      setActive(id);
      el.setAttribute('tabindex','-1');
      el.focus({ preventScroll: true });
    });
  });

  // Recompute targets if DOM shifts (optional safety)
  const refreshTargets = () => { targets = links.map(getTarget).filter(Boolean); };

  // Scroll-based active state
  if ('IntersectionObserver' in window && targets.length) {
    const io = new IntersectionObserver((entries) => {
      // consider the top-most visible target as active
      const visible = entries.filter(e => e.isIntersecting)
                             .sort((a,b) => a.boundingClientRect.top - b.boundingClientRect.top);
      if (visible[0]) setActive(visible[0].target.id);
    }, { root: null, rootMargin: `-${offset + 1}px 0px -70% 0px`, threshold: [0, 0.01, 0.25] });

    targets.forEach(t => io.observe(t));
    window.addEventListener('resize', () => { refreshTargets(); });
  } else {
    // Fallback: measure on scroll
    const onScroll = () => {
      if (!targets.length) return;
      const y = window.scrollY + offset + 1;
      let current = targets[0];
      for (const el of targets) { if (el.offsetTop <= y) current = el; else break; }
      setActive(current.id);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', () => { refreshTargets(); onScroll(); });
    document.addEventListener('DOMContentLoaded', onScroll);
    onScroll();
  }
})();
</script>


{% schema %}
{
  "name": "Sticky Anchor Nav",
  "tag": "section",
  "class": "section",
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    { "type": "select", "id": "desktop_content_position", "label": "Desktop content position",
      "options": [ { "value": "left","label":"Left" }, { "value":"center","label":"Center" }, { "value":"right","label":"Right" } ],
      "default": "center"
    },
    { "type": "select", "id": "content_alignment", "label": "Content alignment",
      "options": [ { "value":"left","label":"Left" }, { "value":"center","label":"Center" }, { "value":"right","label":"Right" } ],
      "default": "center"
    },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "checkbox", "id": "full_width", "default": true, "label": "Full width" },
    { "type": "range", "id": "sticky_top", "min": 0, "max": 200, "step": 10, "unit": "px", "label": "Sticky top offset", "default": 80 },
    { "type": "range", "id": "scroll_offset", "min": 0, "max": 200, "step": 10, "unit": "px", "label": "Scroll offset for anchors", "info": "Usually equals your sticky top offset. Increase if you have a sticky header above this.", "default": 80 },
    { "type": "checkbox", "id": "add_shadow", "label": "Add subtle shadow", "default": true }
  ],
  "blocks": [
    { "type": "anchor_button", "name": "Anchor button", "limit": 10,
      "settings": [
        { "type": "text", "id": "button_label", "label": "Button label", "default": "Our Story" },
        { "type": "text", "id": "anchor_id", "label": "Anchor ID (target)", "info": "Matches the Anchor ID on the target section (e.g. our-story)" },
        { "type": "checkbox", "id": "button_style_secondary", "label": "Secondary style", "default": false }
      ]
    }
  ],
  "presets": [
    { "name": "Sticky Anchor Nav",
      "blocks": [
        { "type": "anchor_button", "settings": { "button_label": "Our Story", "anchor_id": "our-story" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Guarantee", "anchor_id": "our-guarantee" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Service", "anchor_id": "our-service" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Quality", "anchor_id": "our-quality" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Scientists", "anchor_id": "our-scientists" } }
      ]
    }
  ]
}
{% endschema %}
