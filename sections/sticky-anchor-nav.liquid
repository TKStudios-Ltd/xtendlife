{% comment %}
  Sticky Anchor Nav (Dawn) — v3 hybrid
  - Uses position: sticky when possible
  - Falls back to position: fixed with a placeholder to avoid layout jump
{% endcomment %}

{%- style -%}
  #shopify-section-{{ section.id }} { overflow: visible; position: relative; z-index: 2; } /* prevent clipping */
  .sticky-anchor-nav__wrap--{{ section.id }}{
    position: -webkit-sticky;
    position: sticky;
    top: {{ section.settings.sticky_top | default: 0 }}px;
    z-index: 40;
  }
  .sn-fixed-placeholder--{{ section.id }}{ height: 0; }

  .sticky-anchor-nav--{{ section.id }}.has-shadow { box-shadow: 0 2px 12px rgba(0,0,0,.06); }

  .sticky-anchor-nav--{{ section.id }} .rich-text__blocks{
    display:flex; gap:10px; align-items:center; white-space:nowrap;
    overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
  }
  .sticky-anchor-nav--{{ section.id }} .rich-text__blocks::-webkit-scrollbar{display:none;}
  .sticky-anchor-nav--{{ section.id }} .rich-text__buttons{display:inline-flex;}
  .sticky-anchor-nav--{{ section.id }} a.button.is-active{ background: rgba(31, 25, 70, 1); color: white; }
  .sticky-anchor-nav--{{ section.id }} .rich-text__wrapper{ padding: 3rem 0; }
  html:focus-within{ scroll-behavior:smooth; }
{%- endstyle -%}

<div class="isolate{% unless section.settings.full_width %} page-width{% endunless %}">
  <!-- placeholder to preserve height when we switch to fixed -->
  <div class="sn-fixed-placeholder--{{ section.id }}" aria-hidden="true"></div>

  <!-- sticky wrapper (works if ancestors allow it) -->
  <div class="sticky-anchor-nav__wrap--{{ section.id }}" data-sticky-wrap>
    <nav
      id="sticky-anchor-nav-{{ section.id }}"
      class="rich-text content-container color-{{ section.settings.color_scheme }} gradient{% if section.settings.full_width %} rich-text--full-width content-container--full-width{% endif %} sticky-anchor-nav--{{ section.id }}{% if section.settings.add_shadow %} has-shadow{% endif %}"
      data-scroll-offset="{{ section.settings.scroll_offset | default: section.settings.sticky_top | default: 80 }}"
      aria-label="Section navigation"
    >
      <div class="rich-text__wrapper rich-text__wrapper--{{ section.settings.desktop_content_position }}{% if section.settings.full_width %} page-width{% endif %}">
        <div class="rich-text__blocks {{ section.settings.content_alignment }}">
          {%- assign order = 0 -%}
          {%- for block in section.blocks -%}
            {%- if block.type == 'anchor_button' -%}
              {%- assign order = order | plus: 1 -%}
              <div class="rich-text__buttons{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
                   {{ block.shopify_attributes }}
                   {% if settings.animations_reveal_on_scroll %} data-cascade style="--animation-order: {{ order }};"{% endif %}>
                {%- assign label = block.settings.button_label | strip -%}
                {%- assign target = block.settings.anchor_id | handleize -%}
                {%- if label != blank -%}
                  <a
                    {% if target == blank %}role="link" aria-disabled="true"{% else %}href="#{{ target }}"{% endif %}
                    class="button{% if block.settings.button_style_secondary %} button--secondary{% else %} button--primary{% endif %}{% if forloop.first %} is-active{% endif %}"
                    data-anchor="{{ target }}"
                    {% if forloop.first %}aria-current="true"{% endif %}
                  >{{- label | escape -}}</a>
                {%- endif -%}
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </nav>
  </div>
</div>

<script>
(() => {
  const nav = document.getElementById('sticky-anchor-nav-{{ section.id }}');
  if (!nav) return;

  const wrap = nav.closest('[data-sticky-wrap]');
  const placeholder = document.querySelector('.sn-fixed-placeholder--{{ section.id }}');
  const offset = parseFloat(nav.dataset.scrollOffset || '80') || 80;

  // ---- ACTIVE BUTTON SYNC ----
  const links = Array.from(nav.querySelectorAll('a[data-anchor]'));
  const targets = links.map(a => a.dataset.anchor).filter(Boolean).map(id => document.getElementById(id)).filter(Boolean);

  const setActive = (id) => {
    links.forEach(a => {
      const on = a.dataset.anchor === id;
      a.classList.toggle('is-active', on);
      if (on) a.setAttribute('aria-current','true'); else a.removeAttribute('aria-current');
    });
  };

  const syncActive = () => {
    if (!targets.length) return;
    const y = window.scrollY + offset + 1;
    let current = targets[0];
    for (const el of targets) { if (el.offsetTop <= y) current = el; else break; }
    setActive(current.id);
  };

  links.forEach(a => {
    a.addEventListener('click', (e) => {
      const id = a.dataset.anchor, el = id && document.getElementById(id);
      if (!el) return;
      e.preventDefault();
      const top = el.getBoundingClientRect().top + window.pageYOffset - offset;
      window.scrollTo({ top, behavior: 'smooth' });
      el.setAttribute('tabindex','-1'); el.focus({ preventScroll: true });
    });
  });

  // ---- HYBRID STICKY/FIXED HANDLING ----
  let usingFixed = false;

  const measure = () => {
    // Measure the visual container we want to align to (page width)
    const container = nav.closest('.isolate') || nav.parentElement;
    const rect = container.getBoundingClientRect();
    return { left: rect.left + window.pageXOffset, width: rect.width, height: nav.offsetHeight, start: (wrap.getBoundingClientRect().top + window.pageYOffset) - offset };
  };

  const applyFixed = ({left, width, height}) => {
    if (usingFixed) return;
    usingFixed = true;
    placeholder.style.height = height + 'px';
    nav.style.position = 'fixed';
    nav.style.top = offset + 'px';
    nav.style.left = left + 'px';
    nav.style.width = width + 'px';
    nav.style.zIndex = 60;
  };

  const removeFixed = () => {
    if (!usingFixed) return;
    usingFixed = false;
    placeholder.style.height = '0px';
    nav.style.position = '';
    nav.style.top = '';
    nav.style.left = '';
    nav.style.width = '';
    nav.style.zIndex = '';
  };

  // Detect whether sticky is “actually” sticking by observing wrap’s top
  let lastStateFixed = null;
  const onScroll = () => {
    const m = measure();
    const shouldFix = window.scrollY >= m.start;
    // If native sticky works, the nav will already be pinned by the wrapper; no harm leaving it.
    // But if ancestor overflow breaks sticky, we enforce fixed.
    if (shouldFix) applyFixed(m); else removeFixed();
    syncActive();
    lastStateFixed = shouldFix;
  };

  const onResize = () => {
    if (!usingFixed) return;
    const m = measure();
    placeholder.style.height = m.height + 'px';
    nav.style.left = m.left + 'px';
    nav.style.width = m.width + 'px';
  };

  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', onResize);
  document.addEventListener('DOMContentLoaded', onScroll);
  onScroll();
})();
</script>

{% schema %}
{
  "name": "Sticky Anchor Nav",
  "tag": "section",
  "class": "section",
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    { "type": "select", "id": "desktop_content_position", "label": "Desktop content position",
      "options": [ { "value": "left","label":"Left" }, { "value":"center","label":"Center" }, { "value":"right","label":"Right" } ],
      "default": "center"
    },
    { "type": "select", "id": "content_alignment", "label": "Content alignment",
      "options": [ { "value":"left","label":"Left" }, { "value":"center","label":"Center" }, { "value":"right","label":"Right" } ],
      "default": "center"
    },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "checkbox", "id": "full_width", "default": true, "label": "Full width" },
    { "type": "range", "id": "sticky_top", "min": 0, "max": 200, "step": 10, "unit": "px", "label": "Sticky top offset", "default": 80 },
    { "type": "range", "id": "scroll_offset", "min": 0, "max": 200, "step": 10, "unit": "px", "label": "Scroll offset for anchors", "info": "Usually equals your sticky top offset. Increase if you have a sticky header above this.", "default": 80 },
    { "type": "checkbox", "id": "add_shadow", "label": "Add subtle shadow", "default": true }
  ],
  "blocks": [
    { "type": "anchor_button", "name": "Anchor button", "limit": 10,
      "settings": [
        { "type": "text", "id": "button_label", "label": "Button label", "default": "Our Story" },
        { "type": "text", "id": "anchor_id", "label": "Anchor ID (target)", "info": "Matches the Anchor ID on the target section (e.g. our-story)" },
        { "type": "checkbox", "id": "button_style_secondary", "label": "Secondary style", "default": false }
      ]
    }
  ],
  "presets": [
    { "name": "Sticky Anchor Nav",
      "blocks": [
        { "type": "anchor_button", "settings": { "button_label": "Our Story", "anchor_id": "our-story" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Guarantee", "anchor_id": "our-guarantee" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Service", "anchor_id": "our-service" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Quality", "anchor_id": "our-quality" } },
        { "type": "anchor_button", "settings": { "button_label": "Our Scientists", "anchor_id": "our-scientists" } }
      ]
    }
  ]
}
{% endschema %}
