{% comment %}
  Collection Tabs (Dawn‑compatible)
  - Four optional tabs, each showing products from a chosen collection.
  - Uses Dawn’s product grid classes and card-product snippet for full visual parity.
  - Lightweight, accessible tabs (no jQuery). Supports deep links via #tab-{n}.
  - Optional quick add (standard / bulk) like main-collection-product-grid.

  File: sections/collection-tabs-dawn.liquid
{% endcomment %}

{{ 'template-collection.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}

{% if section.settings.image_shape == 'blob' %}
  {{ 'mask-blobs.css' | asset_url | stylesheet_tag }}
{% endif %}

{% unless section.settings.quick_add == 'none' %}
  {{ 'quick-add.css' | asset_url | stylesheet_tag }}
{% endunless %}

{% if section.settings.quick_add == 'standard' %}
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
{% endif %}

{% if section.settings.quick_add == 'bulk' %}
  <script src="{{ 'quick-add-bulk.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'quantity-popover.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'price-per-item.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'quick-order-list.js' | asset_url }}" defer="defer"></script>
{% endif %}

{%- style -%}
  .section-{{ section.id }}-padding { padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px; padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px; }
  @media (min-width: 750px){ .section-{{ section.id }}-padding { padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px; } }

  /* Tabs */
  .tabs { width: 100%; }
  .tabs__nav { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
  .tabs__btn{ border:1px solid rgb(var(--color-foreground)); background:transparent; border-radius:999px; padding:.55rem 1rem; font-weight:600; cursor:pointer; }
  .tabs__btn[aria-selected="true"]{ background: rgb(var(--color-foreground)); color: rgb(var(--color-background)); }
  .tabs__panel[hidden]{ display:none; }
{%- endstyle -%}

<div class="section-{{ section.id }}-padding gradient color-{{ section.settings.color_scheme }}">
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <div class="title-wrapper center">
        <h2 class="title {{ section.settings.heading_size }}">{{ section.settings.heading }}</h2>
      </div>
    {% endif %}

    {% assign tabs = '' %}
    {% assign tabs = tabs | append: section.settings.tab_1_label | append: '||' | append: section.settings.tab_2_label | append: '||' | append: section.settings.tab_3_label | append: '||' | append: section.settings.tab_4_label %}

    <div class="tabs" id="CollectionTabs-{{ section.id }}">
      <div class="tabs__nav" role="tablist" aria-label="{{ section.settings.heading | default: 'Collections' }}">
        {% for i in (1..4) %}
          {% assign label_key = 'tab_' | append: i | append: '_label' %}
          {% assign coll_key  = 'tab_' | append: i | append: '_collection' %}
          {% assign label = section.settings[label_key] %}
          {% assign handle = section.settings[coll_key] %}
          {% if label != blank and handle != blank %}
            {% assign tab_id = 'tab-' | append: section.id | append: '-' | append: i %}
            <button class="tabs__btn" role="tab" id="{{ tab_id }}" aria-controls="{{ tab_id }}-panel" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">{% if section.settings.show_counts %}{% assign c = collections[handle] %}{{ label }} ({{ c.products_count }}){% else %}{{ label }}{% endif %}</button>
          {% endif %}
        {% endfor %}
      </div>

      {% comment %} Panels {% endcomment %}
      {% for i in (1..4) %}
        {% assign label_key = 'tab_' | append: i | append: '_label' %}
        {% assign coll_key  = 'tab_' | append: i | append: '_collection' %}
        {% assign link_key  = 'tab_' | append: i | append: '_view_all' %}
        {% assign limit_key = 'tab_' | append: i | append: '_limit' %}
        {% assign label = section.settings[label_key] %}
        {% assign handle = section.settings[coll_key] %}
        {% assign view_all = section.settings[link_key] %}
        {% assign limit = section.settings[limit_key] | default: section.settings.default_limit %}
        {% if label != blank and handle != blank %}
          {% assign coll = collections[handle] %}
          {% assign tab_id = 'tab-' | append: section.id | append: '-' | append: i %}
          <div class="tabs__panel" id="{{ tab_id }}-panel" role="tabpanel" aria-labelledby="{{ tab_id }}" {% unless forloop.first %}hidden{% endunless %}>
            <div class="product-grid-container{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"{% if settings.animations_reveal_on_scroll %} data-cascade{% endif %}>
              {% if coll.products_count == 0 %}
                <div class="collection collection--empty">
                  <div class="title-wrapper center">
                    <h3 class="title title--primary">{{ 'sections.collection_template.empty' | t }}</h3>
                  </div>
                </div>
              {% else %}
                <div class="collection">
                  <div class="loading-overlay gradient"></div>
                  <ul class="grid product-grid grid--{{ section.settings.columns_mobile }}-col-tablet-down grid--{{ section.settings.columns_desktop }}-col-desktop {% if section.settings.quick_add == 'bulk' %}collection-quick-add-bulk{% endif %}" data-id="{{ section.id }}">
                    {% assign skip_card_product_styles = false %}
                    {% for product in coll.products limit: limit %}
                      {% assign lazy_load = false %}
                      {% if forloop.index > 2 %}{% assign lazy_load = true %}{% endif %}
                      <li class="grid__item{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}" {% if settings.animations_reveal_on_scroll %}data-cascade style="--animation-order: {{ forloop.index }};"{% endif %}>
                        {% render 'card-product',
                          card_product: product,
                          media_aspect_ratio: section.settings.image_ratio,
                          image_shape: section.settings.image_shape,
                          show_secondary_image: section.settings.show_secondary_image,
                          show_vendor: section.settings.show_vendor,
                          show_rating: section.settings.show_rating,
                          lazy_load: lazy_load,
                          skip_styles: skip_card_product_styles,
                          quick_add: section.settings.quick_add,
                          section_id: section.id %}
                      </li>
                      {% assign skip_card_product_styles = true %}
                    {% endfor %}
                  </ul>

                  {% if view_all %}
                    <div class="center" style="margin-top: var(--sp-6, 2rem);">
                      <a class="button" href="{{ coll.url }}">{{ 'sections.collection_list.view_all' | t }}</a>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  {% if section.settings.image_shape == 'arch' %}
    {{ 'mask-arch.svg' | inline_asset_content }}
  {% endif %}
</div>

<script>
  (() => {
    const root = document.getElementById('CollectionTabs-{{ section.id }}');
    if (!root) return;
    const tabs = Array.from(root.querySelectorAll('[role="tab"]'));
    const panels = Array.from(root.querySelectorAll('[role="tabpanel"]'));
    if (!tabs.length) return;

    function activate(idx, focus = true){
      tabs.forEach((t, i) => {
        const selected = i === idx;
        t.setAttribute('aria-selected', selected ? 'true' : 'false');
        if (focus && selected) t.focus();
        const panel = document.getElementById(t.id + '-panel');
        if (panel) panel.toggleAttribute('hidden', !selected);
      });
      // Update hash for deep link
      history.replaceState(null, '', '#{{ section.id }}:' + (idx+1));
    }

    tabs.forEach((t, i) => {
      t.addEventListener('click', () => activate(i, false));
      t.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
          e.preventDefault();
          const dir = e.key === 'ArrowRight' ? 1 : -1;
          const next = (i + dir + tabs.length) % tabs.length;
          activate(next);
        }
      });
    });

    // Deep-link: #<section.id>:<n>
    const hash = location.hash.slice(1);
    if (hash.startsWith('{{ section.id }}:')){
      const num = parseInt(hash.split(':')[1], 10);
      if (!Number.isNaN(num) && num >= 1 && num <= tabs.length){ activate(num-1, false); }
    }
  })();
</script>

{% schema %}
{
  "name": "Collection Tabs",
  "class": "section",
  "settings": [
    {"type":"text","id":"heading","label":"Heading","default":"Featured collections"},
    {"type":"select","id":"heading_size","label":"Heading size","default":"title--medium","options":[
      {"value":"title--small","label":"Small"},
      {"value":"title--medium","label":"Medium"},
      {"value":"title--large","label":"Large"}
    ]},

    {"type":"checkbox","id":"show_counts","label":"Show product counts on tabs","default":false},

    {"type":"header","content":"Tab 1"},
    {"type":"text","id":"tab_1_label","label":"Label","default":"New"},
    {"type":"collection","id":"tab_1_collection","label":"Collection"},
    {"type":"range","id":"tab_1_limit","label":"Products to show","min":4,"max":48,"step":4,"default":16},

    {"type":"header","content":"Tab 2"},
    {"type":"text","id":"tab_2_label","label":"Label","default":"Best sellers"},
    {"type":"collection","id":"tab_2_collection","label":"Collection"},
    {"type":"range","id":"tab_2_limit","label":"Products to show","min":4,"max":48,"step":4,"default":16},

    {"type":"header","content":"Tab 3"},
    {"type":"text","id":"tab_3_label","label":"Label"},
    {"type":"collection","id":"tab_3_collection","label":"Collection"},
    {"type":"range","id":"tab_3_limit","label":"Products to show","min":4,"max":48,"step":4,"default":16},

    {"type":"header","content":"Tab 4"},
    {"type":"text","id":"tab_4_label","label":"Label"},
    {"type":"collection","id":"tab_4_collection","label":"Collection"},
    {"type":"range","id":"tab_4_limit","label":"Products to show","min":4,"max":48,"step":4,"default":16},

    {"type":"checkbox","id":"tab_1_view_all","label":"Show ‘View all’ button on Tab 1","default":true},
    {"type":"checkbox","id":"tab_2_view_all","label":"Show ‘View all’ button on Tab 2","default":true},
    {"type":"checkbox","id":"tab_3_view_all","label":"Show ‘View all’ button on Tab 3","default":true},
    {"type":"checkbox","id":"tab_4_view_all","label":"Show ‘View all’ button on Tab 4","default":true},

    {"type":"header","content":"Grid & Cards"},
    {"type":"range","id":"columns_desktop","min":1,"max":6,"step":1,"default":4,"label":"Columns (desktop)"},
    {"type":"select","id":"columns_mobile","default":"2","label":"Columns (mobile)","options":[
      {"value":"1","label":"1"},
      {"value":"2","label":"2"}
    ]},
    {"type":"select","id":"image_ratio","label":"Image ratio","default":"adapt","options":[
      {"value":"adapt","label":"Adapt"},
      {"value":"portrait","label":"Portrait"},
      {"value":"square","label":"Square"}
    ]},
    {"type":"select","id":"image_shape","label":"Image shape","default":"default","options":[
      {"value":"default","label":"Default"},
      {"value":"arch","label":"Arch"},
      {"value":"blob","label":"Blob"},
      {"value":"chevronleft","label":"Chevron Left"},
      {"value":"chevronright","label":"Chevron Right"},
      {"value":"diamond","label":"Diamond"},
      {"value":"parallelogram","label":"Parallelogram"},
      {"value":"round","label":"Round"}
    ]},
    {"type":"checkbox","id":"show_secondary_image","default":false,"label":"Show second image on hover"},
    {"type":"checkbox","id":"show_vendor","default":false,"label":"Show vendor"},
    {"type":"checkbox","id":"show_rating","default":false,"label":"Show rating"},

    {"type":"select","id":"quick_add","default":"none","label":"Quick add","options":[
      {"value":"none","label":"None"},
      {"value":"standard","label":"Standard"},
      {"value":"bulk","label":"Bulk (B2B style)"}
    ]},

    {"type":"color_scheme","id":"color_scheme","label":"Color scheme","default":"scheme-1"},
    {"type":"range","id":"padding_top","min":0,"max":100,"step":4,"unit":"px","label":"Padding top","default":36},
    {"type":"range","id":"padding_bottom","min":0,"max":100,"step":4,"unit":"px","label":"Padding bottom","default":36},

    {"type":"range","id":"default_limit","label":"Default products to show (fallback)","min":4,"max":48,"step":4,"default":16}
  ],
  "presets": [
    {"name":"Collection Tabs","category":"Collection"}
  ]
}
{% endschema %}
